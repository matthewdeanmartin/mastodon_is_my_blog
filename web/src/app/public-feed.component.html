<div class="card">
  <h2 class="post-title">
    {{ currentFilter === 'all' ? 'Latest Storms' : (currentFilter | titlecase) + ' Feed' }}
  </h2>

  <div *ngIf="loading" class="muted">Loading...</div>

  <div *ngIf="isStormView && !loading">
    <div *ngFor="let storm of items; let i = index">
        <hr *ngIf="i > 0"/>

        <ng-container *ngTemplateOutlet="postTemplate; context:{$implicit: storm.root}"></ng-container>

        <div style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 15px;">
            <div *ngFor="let branch of storm.branches">
                <ng-container *ngTemplateOutlet="postTemplate; context:{$implicit: branch}"></ng-container>
            </div>
        </div>
    </div>
  </div>

  <div *ngIf="!isStormView && !loading">
    <div *ngFor="let p of items; let i = index">
        <hr *ngIf="i > 0"/>
        <ng-container *ngTemplateOutlet="postTemplate; context:{$implicit: p}"></ng-container>
    </div>
  </div>

  <div *ngIf="!loading && items.length === 0" class="muted">
    No posts found for this filter.
  </div>
</div>

<ng-template #postTemplate let-p>
    <div class="row" style="margin-bottom: 5px;">
      <a [routerLink]="['/p', p.id]" class="muted" style="font-size:0.85rem;">
        <span *ngIf="p.created_at">{{ p.created_at | date:'mediumDate' }}</span>
        <span *ngIf="!p.created_at">Just now</span>
      </a>
      <span *ngIf="p.is_reblog" class="badge">REBLOG</span>
      <span *ngIf="p.is_reply" class="badge">REPLY</span>
    </div>

    <div class="post-body">
      <span [innerHTML]="stripHtml(p.content).slice(0, 2000) + (p.content.length > 2000 ? '...' : '')"></span>
    </div>

    <div *ngIf="getImages(p).length > 0" style="margin-top: 10px; display: flex; gap: 8px; overflow-x: auto;">
        <img
          *ngFor="let img of getImages(p)"
          [src]="img.preview_url || img.url"
          style="height: 120px; width: auto; border-radius: 4px; border: 1px solid #eee;"
        >
    </div>

    <div style="margin-top:6px; margin-bottom: 15px;">
      <a [routerLink]="['/p', p.id]"><small>Read more</small></a>
      <span *ngIf="p.counts" class="muted" style="margin-left: 10px; font-size: 0.8rem;">
         {{ p.counts.replies }} replies &bull; {{ p.counts.likes }} likes
      </span>
    </div>
</ng-template>
