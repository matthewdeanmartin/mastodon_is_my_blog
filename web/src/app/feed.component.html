<div class="card">
  <h2 class="post-title">
    {{ (currentFilter === 'all' || currentFilter === 'storms') ? 'Latest Storms' : (currentFilter | titlecase) }}
  </h2>

  <div *ngIf="loading" class="muted">Loading...</div>

  <div *ngIf="isStormView && !loading">
    <div *ngFor="let storm of items; let i = index">
      <hr *ngIf="i > 0" />

      <ng-container
        *ngTemplateOutlet="postTemplate; context: { $implicit: storm.root }"
      ></ng-container>

      <div style="margin-left: 20px; border-left: 2px solid #eee; padding-left: 15px">
        <div *ngFor="let branch of storm.branches">
          <ng-container
            *ngTemplateOutlet="postTemplate; context: { $implicit: branch }"
          ></ng-container>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isStormView && !loading">
    <div *ngFor="let p of items; let i = index">
      <hr *ngIf="i > 0" />
      <ng-container *ngTemplateOutlet="postTemplate; context: { $implicit: p }"></ng-container>
    </div>
  </div>

  <div *ngIf="!loading && items.length === 0" class="muted">No posts found for this filter.</div>
</div>

<ng-template #postTemplate let-p>
  <div class="row" style="margin-bottom: 5px">
    <a
      [routerLink]="['/p', p.id]"
      [queryParams]="getQueryParams()"
      class="muted"
      style="font-size: 0.85rem"
    >
      <span *ngIf="p.created_at">{{ p.created_at | date: 'mediumDate' }}</span>
      <span *ngIf="!p.created_at">Just now</span>
    </a>
    <div>
      <span
        *ngIf="p.is_reblog"
        style="
          background: #e3f2fd;
          color: #1976d2;
          padding: 2px 8px;
          border-radius: 3px;
          font-size: 0.75rem;
          font-weight: 600;
        "
        >REBLOG</span
      >
      <span
        *ngIf="p.is_reply"
        style="
          background: #f3e5f5;
          color: #7b1fa2;
          padding: 2px 8px;
          border-radius: 3px;
          font-size: 0.75rem;
          font-weight: 600;
          margin-left: 4px;
        "
        >REPLY</span
      >
    </div>
  </div>

  <div class="post-body">
    <!-- First show a plain text preview, then link to full post -->
    <!--    <span>{{ stripHtml(p.content).slice(0, 2000) }}{{ p.content.length > 2000 ? '...' : '' }}</span>-->
    <span [innerHTML]="stripHtml(p.content)"></span>
  </div>

  <div
    *ngIf="getImages(p).length > 0"
    style="margin-top: 10px; display: flex; flex-direction: column; gap: 8px;"
  >
    <img
      *ngFor="let img of getImages(p)"
      [src]="img.preview_url || img.url"
      style="width: 100%; height: auto; border-radius: 4px; border: 1px solid #eee"
    />
  </div>

  <div style="margin-top: 6px; margin-bottom: 15px">
    <a [routerLink]="['/p', p.id]"><small>Read more</small></a>
    <span *ngIf="p.counts" class="muted" style="margin-left: 10px; font-size: 0.8rem">
      {{ p.counts.replies }} replies &bull; {{ p.counts.likes }} likes
    </span>
    <span style="margin-left: 10px;">
      <a [href]="getOriginalPostUrl(p)" target="_blank" rel="noopener noreferrer"
         style="font-size: 0.8rem; color: #6366f1; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
        <span style="font-size: 1rem;">ðŸ”—</span> View on Mastodon
      </a>
    </span>
  </div>
</ng-template>
